var PlayerMovement=pc.createScript("playerMovement");PlayerMovement.attributes.add("speed",{type:"number",default:5}),PlayerMovement.attributes.add("smoothTime",{type:"number",default:.1}),PlayerMovement.attributes.add("minX",{type:"number",default:-1}),PlayerMovement.attributes.add("maxX",{type:"number",default:1}),PlayerMovement.attributes.add("scrollBar",{type:"entity",default:null}),PlayerMovement.attributes.add("threshold",{type:"number",default:.01,description:"Минимальное изменение ScrollBar для поворота персонажа"}),PlayerMovement.attributes.add("movementSpeed",{type:"number",default:5,description:"Скорость отклика движения персонажа"}),PlayerMovement.prototype.initialize=function(){this.targetPositionX=this.entity.getPosition().x,this.usingScrollBar=!!this.scrollBar,this.usingScrollBar&&(this.previousScrollValue=this.scrollBar.scrollbar.value,this.lastTargetX=this.targetPositionX,this.idleTimer=0),this.direction=0,this.currentState="Idle",this.keyDownTime={},this.quickTapThreshold=200,this.leftPressed=!1,this.rightPressed=!1;const t=this.app.keyboard;t.on(pc.EVENT_KEYDOWN,(t=>{const e=pc.now();t.key!==pc.KEY_A&&t.key!==pc.KEY_LEFT||this.leftPressed||(this.leftPressed=!0,this.keyDownTime.left=e,this.direction=-1),t.key!==pc.KEY_D&&t.key!==pc.KEY_RIGHT||this.rightPressed||(this.rightPressed=!0,this.keyDownTime.right=e,this.direction=1)})),t.on(pc.EVENT_KEYUP,(t=>{const e=pc.now();if(t.key===pc.KEY_A||t.key===pc.KEY_LEFT){const t=e-(this.keyDownTime.left||e);this.leftPressed=!1,this.rightPressed?this.direction=1:this.direction=0,t<this.quickTapThreshold?(this.entity.sprite.play("MoveRightNoLoop"),this.currentState="MoveRightNoLoop"):this.rightPressed||(this.entity.sprite.play("Idle"),this.currentState="Idle")}if(t.key===pc.KEY_D||t.key===pc.KEY_RIGHT){const t=e-(this.keyDownTime.right||e);this.rightPressed=!1,this.leftPressed?this.direction=-1:this.direction=0,t<this.quickTapThreshold?(this.entity.sprite.play("MoveLeftNoLoop"),this.currentState="MoveLeftNoLoop"):this.leftPressed||(this.entity.sprite.play("Idle"),this.currentState="Idle")}})),this.lastScrollChangeTime=0,this.idleThreshold=10},PlayerMovement.prototype.update=function(t){this.usingScrollBar?this.updateWithScrollBar(t):this.updateWithKeyboard(t)},PlayerMovement.prototype.updateWithScrollBar=function(t){const e=this.scrollBar.scrollbar.value;this.targetPositionX=pc.math.lerp(this.minX,this.maxX,e);const i=this.entity.getPosition(),s=pc.math.lerp(i.x,this.targetPositionX,this.smoothTime);this.entity.setPosition(s,i.y,i.z);Math.abs(this.targetPositionX-this.lastTargetX)>this.threshold?(this.idleTimer=0,this.targetPositionX<i.x&&"MoveLeft"!==this.currentState?(this.entity.sprite.play("MoveLeft"),this.currentState="MoveLeft"):this.targetPositionX>i.x&&"MoveRight"!==this.currentState&&(this.entity.sprite.play("MoveRight"),this.currentState="MoveRight")):(this.idleTimer+=t,this.idleTimer>=.1&&"Idle"!==this.currentState&&(this.entity.sprite.play("Idle"),this.currentState="Idle")),this.lastTargetX=this.targetPositionX},PlayerMovement.prototype.updateWithKeyboard=function(t){this.targetPositionX+=this.direction*this.speed*t,this.targetPositionX=pc.math.clamp(this.targetPositionX,this.minX,this.maxX);const e=this.entity.getPosition(),i=pc.math.lerp(e.x,this.targetPositionX,this.smoothTime);this.entity.setPosition(i,e.y,e.z),this.direction<0&&this.leftPressed&&"MoveLeft"!==this.currentState&&(this.entity.sprite.play("MoveLeft"),this.currentState="MoveLeft"),this.direction>0&&this.rightPressed&&"MoveRight"!==this.currentState&&(this.entity.sprite.play("MoveRight"),this.currentState="MoveRight")};var FallingObject=pc.createScript("fallingObject");FallingObject.attributes.add("children",{type:"entity"}),FallingObject.attributes.add("childrens",{type:"entity",array:!0}),FallingObject.attributes.add("isBluePoof",{type:"boolean"}),FallingObject.prototype.initialize=function(){if(this.isFalling=!0,this.target=null,this.pool=null,null==this.children){if(null!=this.childrens)for(var t=0;t<this.childrens.length;t++)this.childrens[t].collision.on("triggerenter",this.onTriggerEnter,this)}else this.children.collision.on("triggerenter",this.onTriggerEnter,this)},FallingObject.prototype.update=function(t){this.isFalling&&this.entity.translateLocal(0,-FallSpeedController.currSpeed*t,0)},FallingObject.prototype.onTriggerEnter=function(t){t.tags.has("happy")?EmotionsController.instance.playHappy():this.isFalling&&(this.isFalling=!1,t.tags.has("umbrella")&&this.lose(),this.entity.script.scaleToZero.startScaling(.5))},FallingObject.prototype.addInPool=function(){this.isLightning?LightningSpawner.instance.destroyObject(this.entity):ObjectSpawner.instance.destroyObject(this.entity)},FallingObject.prototype.lose=function(){Poof.instance.play(this.entity,this.isBluePoof),SoundManager.instance.play("Lose"),EmotionsController.instance.playSad(),HeartSystem.instance.disableNext()};var ScaleToZero=pc.createScript("scaleToZero");ScaleToZero.attributes.add("scaleSpeed",{type:"number",default:1}),ScaleToZero.prototype.initialize=function(){this.isScaling=!1,this.startScale=null,this.targetScale=new pc.Vec3(0,0,0),this.elapsedTime=0},ScaleToZero.prototype.startScaling=function(e){this.startScale=this.entity.getLocalScale().clone(),this.scaleSpeed=e||1,this.elapsedTime=0,this.isScaling=!0},ScaleToZero.prototype.update=function(e){if(this.isScaling){this.elapsedTime+=e;var t=Math.min(this.elapsedTime/this.scaleSpeed,1),i=new pc.Vec3;i.lerp(this.startScale,this.targetScale,t),this.entity.setLocalScale(i),t>=1&&(this.entity.setLocalScale(this.targetScale),this.isScaling=!1,this.entity.script.fallingObject.addInPool())}};var ObjectSpawner=pc.createScript("objectSpawner");ObjectSpawner.instance=null,ObjectSpawner.attributes.add("xMin",{type:"number",default:-3}),ObjectSpawner.attributes.add("xMax",{type:"number",default:3}),ObjectSpawner.attributes.add("poolIce",{type:"entity"}),ObjectSpawner.attributes.add("poolRain",{type:"entity"}),ObjectSpawner.prototype.initialize=function(){ObjectSpawner.instance=this,this.startY=4.5,this.spawnInterval=1.5,this.maxObjects=10,this.currentObjects=[],this.spawnTimer=0,this.isSpawning=!0,this.spawnCount=0},ObjectSpawner.prototype.update=function(t){this.isSpawning&&(this.spawnTimer+=t,this.spawnTimer>=this.spawnInterval&&(this.spawnTimer=0,this.spawnObjectIfPossible()))},ObjectSpawner.prototype.enableSpawning=function(){SaveSystem.getInstance().data.level>1&&LightningSpawner.instance.enableSpawning(),this.isSpawning=!0},ObjectSpawner.prototype.disableSpawning=function(){SaveSystem.getInstance().data.level>1&&LightningSpawner.instance.disableSpawning(),this.spawnCount=0,this.isSpawning=!1,this.clearCurrentObjects()},ObjectSpawner.prototype.clearCurrentObjects=function(){for(;this.currentObjects.length>0;){const t=this.currentObjects.pop();this.destroyObjectPool(t)}},ObjectSpawner.prototype.spawnObjectIfPossible=function(){if(this.currentObjects.length>=this.maxObjects)return void console.log("Limit");const t=pc.math.random(this.xMin,this.xMax),e=this.startY;let n;const i=pc.math.random(0,2);n=SaveSystem.instance.data.level>0?i<1?this.poolIce:this.poolRain:this.poolIce;const s=n.script.poolSystem.getObject();if(s){const i=new pc.Vec3(t,e,2);s.setPosition(i),s.enabled=!0,s.script.scaleToZero.isScaling=!1,s.script.fallingObject.isFalling=!0,s.setEulerAngles(0,0,0),s.script&&s.script.fallingObject&&(s.script.fallingObject.pool=n),this.currentObjects.push(s),this.spawnCount++}else console.warn("ObjectSpawner: Failed to retrieve object from pool")},ObjectSpawner.prototype.destroyObject=function(t){const e=this.currentObjects.indexOf(t);e>-1&&this.currentObjects.splice(e,1),t.script.fallingObject.pool.script.poolSystem.returnObject(t)},ObjectSpawner.prototype.destroyObjectPool=function(t){t.script.fallingObject.pool.script.poolSystem.returnObject(t)};var ScaleRectByScreenWidth=pc.createScript("scaleRectByScreenWidth");ScaleRectByScreenWidth.attributes.add("scaleFactor",{type:"number",default:1,title:"Scale Factor",description:"Коэффициент масштабирования (от 0 до 1)"}),ScaleRectByScreenWidth.attributes.add("refResolution",{type:"vec2",default:[1920,1080],title:"Reference Resolution",description:"Базовое разрешение экрана"}),ScaleRectByScreenWidth.attributes.add("targetRects",{type:"entity",array:!0,title:"Target Rects",description:"Список целевых объектов для масштабирования"}),ScaleRectByScreenWidth.prototype.initialize=function(){this.initScales=[];for(var t=0;t<this.targetRects.length;t++){var e=this.targetRects[t];e&&(this.initScales[t]=e.getLocalScale().clone())}this.lastWidth=this.app.graphicsDevice.width,this.lastHeight=this.app.graphicsDevice.height,this.updateScale()},ScaleRectByScreenWidth.prototype.update=function(){var t=this.app.graphicsDevice.width,e=this.app.graphicsDevice.height;t===this.lastWidth&&e===this.lastHeight||(this.lastWidth=t,this.lastHeight=e,this.updateScale())},ScaleRectByScreenWidth.prototype.updateScale=function(){var t=this.app.graphicsDevice.width,e=this.app.graphicsDevice.height;if(0!==t&&0!==e){var i=this.refResolution.x/this.refResolution.y,a=t/e;if(a<i)for(var c=pc.math.lerp(1,a/i,this.scaleFactor),s=0;s<this.targetRects.length;s++){if(r=this.targetRects[s]){var h=this.initScales[s];r.setLocalScale(h.x*c,h.y*c,h.z)}}else for(s=0;s<this.targetRects.length;s++){var r;if(r=this.targetRects[s]){h=this.initScales[s];r.setLocalScale(h.x,h.y,h.z)}}}else this.app.once("postupdate",this.updateScale,this)};var PoolSystem=pc.createScript("poolSystem");PoolSystem.attributes.add("assetType",{type:"asset",assetType:"template",title:"Asset Template"}),PoolSystem.attributes.add("scale",{type:"vec3",title:"Scale",default:[1,1,1]}),PoolSystem.prototype.initialize=function(){this.pool=[],this.assetType||console.error("Pool: Asset Template is not set!")},PoolSystem.prototype.getObject=function(){if(this.pool.length>0){var t=this.pool.shift();return t.setLocalScale(this.scale),t}return this.createObject()},PoolSystem.prototype.returnObject=function(t){t.enabled=!1,this.pool.push(t)},PoolSystem.prototype.createObject=function(){if(!this.assetType)return console.error("Pool: Asset Template is not set!"),null;var t=this.assetType.resource.instantiate();return this.app.root.addChild(t),t.setLocalScale(this.scale),t};pc.extend(pc,function(){var TweenManager=function(t){this._app=t,this._tweens=[],this._add=[]};TweenManager.prototype={add:function(t){return this._add.push(t),t},update:function(t){for(var i=0,e=this._tweens.length;i<e;)this._tweens[i].update(t)?i++:(this._tweens.splice(i,1),e--);if(this._add.length){for(let t=0;t<this._add.length;t++)this._tweens.indexOf(this._add[t])>-1||this._tweens.push(this._add[t]);this._add.length=0}}};var Tween=function(t,i,e){pc.events.attach(this),this.manager=i,e&&(this.entity=null),this.time=0,this.complete=!1,this.playing=!1,this.stopped=!0,this.pending=!1,this.target=t,this.duration=0,this._currentDelay=0,this.timeScale=1,this._reverse=!1,this._delay=0,this._yoyo=!1,this._count=0,this._numRepeats=0,this._repeatDelay=0,this._from=!1,this._slerp=!1,this._fromQuat=new pc.Quat,this._toQuat=new pc.Quat,this._quat=new pc.Quat,this.easing=pc.Linear,this._sv={},this._ev={}},_parseProperties=function(t){var i;return t instanceof pc.Vec2?i={x:t.x,y:t.y}:t instanceof pc.Vec3?i={x:t.x,y:t.y,z:t.z}:t instanceof pc.Vec4||t instanceof pc.Quat?i={x:t.x,y:t.y,z:t.z,w:t.w}:t instanceof pc.Color?(i={r:t.r,g:t.g,b:t.b},void 0!==t.a&&(i.a=t.a)):i=t,i};Tween.prototype={to:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this},from:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._from=!0,this},rotate:function(t,i,e,s,n,r){return this._properties=_parseProperties(t),this.duration=i,e&&(this.easing=e),s&&this.delay(s),n&&this.repeat(n),r&&this.yoyo(r),this._slerp=!0,this},start:function(){var t,i,e,s;if(this.playing=!0,this.complete=!1,this.stopped=!1,this._count=0,this.pending=this._delay>0,this._reverse&&!this.pending?this.time=this.duration:this.time=0,this._from){for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this._properties[t],this._ev[t]=this.target[t]);this._slerp&&(this._toQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,this._fromQuat.setFromEulerAngles(i,e,s))}else{for(t in this._properties)this._properties.hasOwnProperty(t)&&(this._sv[t]=this.target[t],this._ev[t]=this._properties[t]);this._slerp&&(i=void 0!==this._properties.x?this._properties.x:this.target.x,e=void 0!==this._properties.y?this._properties.y:this.target.y,s=void 0!==this._properties.z?this._properties.z:this.target.z,void 0!==this._properties.w?(this._fromQuat.copy(this.target),this._toQuat.set(i,e,s,this._properties.w)):(this._fromQuat.setFromEulerAngles(this.target.x,this.target.y,this.target.z),this._toQuat.setFromEulerAngles(i,e,s)))}return this._currentDelay=this._delay,this.manager.add(this),this},pause:function(){this.playing=!1},resume:function(){this.playing=!0},stop:function(){this.playing=!1,this.stopped=!0},delay:function(t){return this._delay=t,this.pending=!0,this},repeat:function(t,i){return this._count=0,this._numRepeats=t,this._repeatDelay=i||0,this},loop:function(t){return t?(this._count=0,this._numRepeats=1/0):this._numRepeats=0,this},yoyo:function(t){return this._yoyo=t,this},reverse:function(){return this._reverse=!this._reverse,this},chain:function(){for(var t=arguments.length;t--;)t>0?arguments[t-1]._chained=arguments[t]:this._chained=arguments[t];return this},onUpdate:function(t){return this.on("update",t),this},onComplete:function(t){return this.on("complete",t),this},onLoop:function(t){return this.on("loop",t),this},update:function(t){if(this.stopped)return!1;if(!this.playing)return!0;if(!this._reverse||this.pending?this.time+=t*this.timeScale:this.time-=t*this.timeScale,this.pending){if(!(this.time>this._currentDelay))return!0;this._reverse?this.time=this.duration-(this.time-this._currentDelay):this.time-=this._currentDelay,this.pending=!1}var i=0;(!this._reverse&&this.time>this.duration||this._reverse&&this.time<0)&&(this._count++,this.complete=!0,this.playing=!1,this._reverse?(i=this.duration-this.time,this.time=0):(i=this.time-this.duration,this.time=this.duration));var e,s,n=0===this.duration?1:this.time/this.duration,r=this.easing(n);for(var h in this._properties)this._properties.hasOwnProperty(h)&&(e=this._sv[h],s=this._ev[h],this.target[h]=e+(s-e)*r);if(this._slerp&&this._quat.slerp(this._fromQuat,this._toQuat,r),this.entity&&(this.entity._dirtifyLocal(),this.element&&this.entity.element&&(this.entity.element[this.element]=this.target),this._slerp&&this.entity.setLocalRotation(this._quat)),this.fire("update",t),this.complete){var a=this._repeat(i);return a?this.fire("loop"):(this.fire("complete",i),this.entity&&this.entity.off("destroy",this.stop,this),this._chained&&this._chained.start()),a}return!0},_repeat:function(t){if(this._count<this._numRepeats){if(this._reverse?this.time=this.duration-t:this.time=t,this.complete=!1,this.playing=!0,this._currentDelay=this._repeatDelay,this.pending=!0,this._yoyo){for(var i in this._properties){var e=this._sv[i];this._sv[i]=this._ev[i],this._ev[i]=e}this._slerp&&(this._quat.copy(this._fromQuat),this._fromQuat.copy(this._toQuat),this._toQuat.copy(this._quat))}return!0}return!1}};var BounceOut=function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},BounceIn=function(t){return 1-BounceOut(1-t)};return{TweenManager:TweenManager,Tween:Tween,Linear:function(t){return t},QuadraticIn:function(t){return t*t},QuadraticOut:function(t){return t*(2-t)},QuadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn:function(t){return t*t*t},CubicOut:function(t){return--t*t*t+1},CubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},QuarticIn:function(t){return t*t*t*t},QuarticOut:function(t){return 1- --t*t*t*t},QuarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},QuinticIn:function(t){return t*t*t*t*t},QuinticOut:function(t){return--t*t*t*t*t+1},QuinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},SineIn:function(t){return 0===t?0:1===t?1:1-Math.cos(t*Math.PI/2)},SineOut:function(t){return 0===t?0:1===t?1:Math.sin(t*Math.PI/2)},SineInOut:function(t){return 0===t?0:1===t?1:.5*(1-Math.cos(Math.PI*t))},ExponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},ExponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},ExponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},CircularIn:function(t){return 1-Math.sqrt(1-t*t)},CircularOut:function(t){return Math.sqrt(1- --t*t)},CircularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},BackIn:function(t){var i=1.70158;return t*t*((i+1)*t-i)},BackOut:function(t){var i=1.70158;return--t*t*((i+1)*t+i)+1},BackInOut:function(t){var i=2.5949095;return(t*=2)<1?t*t*((i+1)*t-i)*.5:.5*((t-=2)*t*((i+1)*t+i)+2)},BounceIn:BounceIn,BounceOut:BounceOut,BounceInOut:function(t){return t<.5?.5*BounceIn(2*t):.5*BounceOut(2*t-1)+.5},ElasticIn:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),-e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/.4))},ElasticOut:function(t){var i,e=.1;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=.4*Math.asin(1/e)/(2*Math.PI),e*Math.pow(2,-10*t)*Math.sin((t-i)*(2*Math.PI)/.4)+1)},ElasticInOut:function(t){var i,e=.1,s=.4;return 0===t?0:1===t?1:(!e||e<1?(e=1,i=.1):i=s*Math.asin(1/e)/(2*Math.PI),(t*=2)<1?e*Math.pow(2,10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*-.5:e*Math.pow(2,-10*(t-=1))*Math.sin((t-i)*(2*Math.PI)/s)*.5+1)}}}()),function(){pc.AppBase.prototype.addTweenManager=function(){this._tweenManager=new pc.TweenManager(this),this.on("update",(function(t){this._tweenManager.update(t)}))},pc.AppBase.prototype.tween=function(t){return new pc.Tween(t,this._tweenManager)},pc.Entity.prototype.tween=function(t,i){var e=this._app.tween(t);return e.entity=this,this.once("destroy",e.stop,e),i&&i.element&&(e.element=i.element),e};var t=pc.AppBase.getApplication();t&&t.addTweenManager()}();var Heart=pc.createScript("heart");Heart.attributes.add("baseHeart",{type:"entity"}),Heart.attributes.add("fillHeart",{type:"entity"}),Heart.prototype.initialize=function(){},Heart.prototype.fill=function(){this.fillHeart.enabled=!0},Heart.prototype.hide=function(){this.fillHeart.enabled=!1};var HeartSystem=pc.createScript("heartSystem");HeartSystem.instance=null,HeartSystem.attributes.add("objects",{type:"entity",array:!0,title:"Objects"}),HeartSystem.prototype.initialize=function(){if(HeartSystem.instance)return console.warn("HeartSystem already exists"),void this.entity.destroy();HeartSystem.instance=this,this.load()},HeartSystem.prototype.load=function(){this.index=0;for(var t=SaveSystem.getInstance().data.heart,e=2;e>=this.objects.length-1-t;e--)this.objects[e].script.heart.fill();this.index=this.objects.length-1-t},HeartSystem.prototype.disableNext=function(){GameManager.instance.failHeart(),this.objects[this.index].script.heart.hide(),this.index++,SaveSystem.instance.data.heart--,this.index>=this.objects.length&&GameManager.instance.failLevel()};var GameManager=pc.createScript("gameManager");GameManager.instance=null,GameManager.attributes.add("player",{type:"entity"}),GameManager.attributes.add("sound",{type:"entity"}),GameManager.prototype.initialize=function(){if(GameManager.instance)return console.log(GameManager.instance),console.warn("GameManager already exists"),void this.entity.destroy();GameManager.instance=this},GameManager.prototype.failHeart=function(){this.resetScene()},GameManager.prototype.failLevel=function(){Logger.getInstance().completedLevel("Lose"),this.nextLevel()},GameManager.prototype.levelCompleted=function(){this.addPoints(),Logger.getInstance().completedLevel("Win"),this.nextLevel()},GameManager.prototype.setTimer=function(){SaveSystem.getInstance().data.timer=60},GameManager.prototype.nextLevel=function(){if(SaveSystem.getInstance().data.level++,FallSpeedController.instance.setSpeed(),ProgressBar.instance.stopTimer(),SaveSystem.getInstance().data.level>=3)return Logger.getInstance().completedGame(),this.gameExit(),SaveSystem.getInstance().data.level=0,SaveSystem.getInstance().data.points=0,this.gameCompleted(),SaveSystem.getInstance().data.heart=2,this.setTimer(),void console.log("Game Completed");SaveSystem.getInstance().data.heart=2,this.setTimer(),this.resetScene(),ProgressBar.instance.load(),IconLevelManager.instance.setIcon(),HeartSystem.instance.load()},GameManager.prototype.addPoints=function(){if(2==SaveSystem.getInstance().data.heart)switch(SaveSystem.getInstance().data.level){case 0:SaveSystem.getInstance().data.points+=150;break;case 1:SaveSystem.getInstance().data.points+=450;break;case 2:SaveSystem.getInstance().data.points+=750}else switch(SaveSystem.getInstance().data.level){case 0:SaveSystem.getInstance().data.points+=100;break;case 1:SaveSystem.getInstance().data.points+=300;break;case 2:SaveSystem.getInstance().data.points+=500}},GameManager.prototype.gameCompleted=function(){},GameManager.prototype.resetScene=function(){ObjectSpawner.instance.disableSpawning(),ObjectSpawner.instance.enableSpawning()},GameManager.prototype.gameExit=function(){this.sound.sound.stop(),SoundManager.instance.soundObject.sound.stop(),ObjectSpawner.instance.disableSpawning(),ProgressBar.instance.stopTimer(),this.player.script.enabled=!1};var Loader=pc.createScript("loader");Loader.attributes.add("btnMob",{type:"entity"}),Loader.attributes.add("btnDesk",{type:"entity"}),Loader.attributes.add("canvasDesktop",{type:"entity"}),Loader.attributes.add("canvasMobile",{type:"entity"}),Loader.attributes.add("buildNumber",{type:"number"}),Loader.prototype.initialize=function(){this.initializeStart()},Loader.prototype.initializeStart=function(){if(this.isMobile())return this.canvasMobile.enabled=!0,void this.btnMob.element.on("click",this.start,this);this.canvasDesktop.enabled=!0,this.btnDesk.element.on("click",this.start,this)},Loader.prototype.start=function(){this.isMobile()?this.loadScene("GameScene_Mobile"):this.loadScene("GameScene_Desktop")},Loader.prototype.isMobile=function(){return!!pc.platform.mobile},Loader.prototype.loadScene=function(t){this.app.scenes.changeScene(t)};pc.script.createLoadingScreen((function(n){!function(){const n=document.createElement("style");n.type="text/css",n.appendChild(document.createTextNode("\n        html, body {\n            margin: 0;\n            padding: 0;\n            height: 100%;\n            overflow: hidden;\n        }\n\n        #application-splash-wrapper {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background-color: #154472;\n            z-index: 9999;\n        }\n\n        #application-splash {\n            position: absolute;\n            top: 0;\n            left: 0;\n            overflow: hidden;\n        }\n\n        .loading-gif {\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n        }\n        ")),document.head.appendChild(n)}(),function(){const n=document.createElement("div");n.id="application-splash-wrapper",document.body.appendChild(n);const e=document.createElement("div");e.id="application-splash",n.appendChild(e);const t=document.createElement("img");function resizeSplash(){e.style.height=`${window.innerHeight}px`,e.style.width=`${window.innerWidth}px`}t.src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExN2hmdmYwM2J6bmNkeTJheWlvZ2gxbnppbXVtOGFic3N4eGVkN214eiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/j5P0DQIOf4PonLi55G/giphy.gif",t.classList.add("loading-gif"),e.appendChild(t),window.addEventListener("resize",resizeSplash),resizeSplash()}(),n.on("preload:end",(function(){n.off("preload:progress")})),n.on("start",(function(){const n=document.getElementById("application-splash-wrapper");n&&n.parentElement&&n.parentElement.removeChild(n)}))}));var DisableObjects=pc.createScript("disableObjects");DisableObjects.attributes.add("button",{type:"entity",title:"Button",description:"Кнопка, которая будет отключать объекты"}),DisableObjects.attributes.add("objectsToDisable",{type:"entity",array:!0,title:"Objects to Disable",description:"Массив объектов, которые нужно отключить"}),DisableObjects.prototype.initialize=function(){this.button&&this.button.element?this.button.element.on("touchstart",this.onButtonPress,this):console.warn("Кнопка не указана или у неё отсутствует компонент Element.")},DisableObjects.prototype.onButtonPress=function(){for(var t=0;t<this.objectsToDisable.length;t++)this.objectsToDisable[t]&&(this.objectsToDisable[t].enabled=!1)};var CloseBtn=pc.createScript("closeBtn");CloseBtn.attributes.add("durationUp",{type:"number",default:.1}),CloseBtn.attributes.add("durationDown",{type:"number",default:.1}),CloseBtn.attributes.add("additionalScale",{type:"vec3",default:[.2,-.2,0],title:"Bounce Scale Change"}),CloseBtn.prototype.initialize=function(){this.startScale=this.entity.getLocalScale().clone(),this.targetScale=this.startScale.clone(),this.entity.element.on("click",this.onButtonPress,this)},CloseBtn.prototype.onButtonPress=function(){this.entity.tween(this.entity.getLocalScale()).to({x:this.targetScale.x+this.additionalScale.x,y:this.targetScale.y+this.additionalScale.y,z:this.targetScale.z+this.additionalScale.z},this.durationUp,pc.SineOut).onComplete((()=>{this.entity.tween(this.entity.getLocalScale()).to(this.startScale,this.durationDown,pc.SineIn).onComplete((()=>{SaveSystem.getInstance().save(),GameManager.instance.gameExit(),console.log("Exit game"),Logger.getInstance().exitGame()})).start()})).start()};var ScaleCameraOrthoSize=pc.createScript("scaleCameraOrthoSize");ScaleCameraOrthoSize.attributes.add("camera",{type:"entity"}),ScaleCameraOrthoSize.attributes.add("refResolution",{type:"vec2",default:[1960,1200],title:"Reference Resolution",description:"Базовое разрешение экрана"}),ScaleCameraOrthoSize.attributes.add("refOrthoSize",{type:"number",default:5,title:"Reference Ortho Size",description:"Ортографический размер для базового разрешения"}),ScaleCameraOrthoSize.prototype.initialize=function(){this.updateOrthoSize(),this.app.graphicsDevice.on("resizecanvas",this.updateOrthoSize,this)},ScaleCameraOrthoSize.prototype.destroy=function(){this.app.graphicsDevice.off("resizecanvas",this.updateOrthoSize,this)},ScaleCameraOrthoSize.prototype.updateOrthoSize=function(){var e=this.refResolution.x/this.refResolution.y,t=this.app.graphicsDevice.width/this.app.graphicsDevice.height;if(t>e)this.camera.camera.orthoHeight=this.refOrthoSize;else{var i=this.refOrthoSize*(e/t);this.camera.camera.orthoHeight=i}};var Logger=pc.createScript("logger");Logger.instance=null,Logger.getInstance=function(){if(!Logger.instance){console.warn("Logger instance not found. Creating new one.");var e=new pc.Entity("Logger");e.addComponent("script"),e.script.create("logger"),pc.app.root.addChild(e)}return Logger.instance},Logger.prototype.initialize=function(){if(Logger.instance)return console.warn("Logger already exists"),void this.entity.destroy();Logger.instance=this,this.entity.reparent(null),this.exitLogs={type:"exit",points:0,heart:0,timer:0,level:0,timeEnd:null},this.endLevelStats={type:"EndLevel",levelState:"",points:0,heart:0,timer:0,level:0},this.gameCompletedStats={type:"GameCompleted",points:0}},Logger.prototype.exitGame=function(){this.exitLogs.points=SaveSystem.getInstance().data.points,this.exitLogs.heart=SaveSystem.getInstance().data.heart+1,this.exitLogs.timer=SaveSystem.getInstance().data.timer,this.exitLogs.level=SaveSystem.getInstance().data.level+1,this.exitLogs.timeEnd=new Date,this.showLogs(this.exitLogs)},Logger.prototype.completedLevel=function(e){this.endLevelStats.points=SaveSystem.getInstance().data.points,this.endLevelStats.heart=SaveSystem.getInstance().data.heart+1,this.endLevelStats.timer=SaveSystem.getInstance().data.timer,this.endLevelStats.level=SaveSystem.getInstance().data.level+1,this.endLevelStats.levelState=e,this.showLogs(this.endLevelStats)},Logger.prototype.completedGame=function(){this.gameCompletedStats.points=SaveSystem.getInstance().data.points,this.showLogs(this.gameCompletedStats)},Logger.prototype.showLogs=function(e){console.log(JSON.parse(JSON.stringify(e))),window.parent.postMessage({action:"gameOver",score:200},"*"),window.parent.postMessage({action:"gameOver",data:e},"*"),window.parent.postMessage(e,"*")};var SaveSystem=pc.createScript("saveSystem");SaveSystem.instance=null,SaveSystem.prototype.data={heart:2,level:0,timer:60,points:0},SaveSystem.prototype.storageKey="myGameSave35",SaveSystem.getInstance=function(){if(!SaveSystem.instance){console.warn("SaveSystem instance not found. Creating new one.");var e=new pc.Entity("SaveSystem");e.addComponent("script"),e.script.create("saveSystem"),pc.app.root.addChild(e)}return SaveSystem.instance},SaveSystem.prototype.initialize=function(){if(SaveSystem.instance)return console.warn("SaveSystem already exists"),void this.entity.destroy();SaveSystem.instance=this,this.load(),this.entity.reparent(null),window.addEventListener("beforeunload",this.save.bind(this))},SaveSystem.prototype.update=function(e){this.saveTimer||(this.saveTimer=0),this.saveTimer+=e,this.saveTimer>=5&&(this.save(),this.saveTimer=0)},SaveSystem.prototype.save=function(){try{var e=JSON.stringify(this.data);localStorage.setItem(this.storageKey,e)}catch(e){console.error("Failed to save:",e)}},SaveSystem.prototype.load=function(){try{var e=localStorage.getItem(this.storageKey);e&&(this.data=JSON.parse(e),console.log("[SaveSystem] Loaded:",this.data))}catch(e){console.error("Failed to load:",e)}};var SoundManager=pc.createScript("soundManager");SoundManager.instance=null,SoundManager.attributes.add("soundObject",{type:"entity"}),SoundManager.prototype.initialize=function(){if(SoundManager.instance)return console.warn("SoundManager already exists"),void this.entity.destroy();SoundManager.instance=this},SoundManager.prototype.play=function(n){this.soundObject.sound.play(n)};var FallSpeedController=pc.createScript("fallSpeedController");FallSpeedController.currSpeed=0,FallSpeedController.instance=null,FallSpeedController.attributes.add("speedLevelOne",{type:"number",default:1}),FallSpeedController.attributes.add("speedLevelTwo",{type:"number",default:2}),FallSpeedController.attributes.add("speedLevelThree",{type:"number",default:3}),FallSpeedController.attributes.add("maxSpeed",{type:"number",default:10}),FallSpeedController.attributes.add("speedIncreaseRate",{type:"number",default:.1}),FallSpeedController.prototype.initialize=function(){FallSpeedController.instance=this,this.fallSpeed=0,this.setSpeed(),this.timeElapsed=0},FallSpeedController.prototype.setSpeed=function(){switch(SaveSystem.getInstance().data.level){case 0:this.fallSpeed=this.speedLevelOne;break;case 1:this.fallSpeed=this.speedLevelTwo;break;case 2:this.fallSpeed=this.speedLevelThree}FallSpeedController.currSpeed=this.fallSpeed},FallSpeedController.prototype.update=function(e){this.timeElapsed+=e;Math.exp(-this.speedIncreaseRate*this.timeElapsed/5);FallSpeedController.currSpeed=this.fallSpeed},FallSpeedController.prototype.reset=function(){FallSpeedController.currSpeed=this.fallSpeed,this.timeElapsed=0};var ProgressBar=pc.createScript("progressBar");ProgressBar.instance=null,ProgressBar.attributes.add("progressImage",{type:"entity"}),ProgressBar.attributes.add("progressImageMaxWidth",{type:"number"}),ProgressBar.attributes.add("fillTime",{type:"number",default:60}),ProgressBar.attributes.add("timerText",{type:"entity"}),ProgressBar.prototype.initialize=function(){ProgressBar.instance=this,this.imageRect=this.progressImage.element.rect.clone(),this.progress=1,this.remainingTime=0,this.isRunning=!1,this.load()},ProgressBar.prototype.load=function(){this.remainingTime=SaveSystem.getInstance().data.timer,this.startTimer(this.remainingTime)},ProgressBar.prototype.setProgress=function(e){e=pc.math.clamp(e,0,1),this.progress=e;var t=pc.math.lerp(0,this.progressImageMaxWidth,e);this.progressImage.element.width=t,this.imageRect.copy(this.progressImage.element.rect),this.imageRect.z=e,this.progressImage.element.rect=this.imageRect},ProgressBar.prototype.updateTimerText=function(e){SaveSystem.getInstance().data.timer=Math.ceil(e),this.timerText&&this.timerText.element&&(this.timerText.element.text=Math.ceil(e).toString())},ProgressBar.prototype.startTimer=function(e){this.remainingTime=e||this.fillTime,this.setProgress(this.remainingTime/this.fillTime),this.updateTimerText(this.remainingTime),this.isRunning=!0},ProgressBar.prototype.stopTimer=function(){this.isRunning=!1},ProgressBar.prototype.onTimerComplete=function(){console.log("End level"),GameManager.instance.levelCompleted()},ProgressBar.prototype.update=function(e){if(this.isRunning){this.remainingTime-=e;var t=this.remainingTime/this.fillTime;this.setProgress(t),this.updateTimerText(this.remainingTime),this.remainingTime<=0&&(this.isRunning=!1,this.updateTimerText(0),this.onTimerComplete())}};var Poof=pc.createScript("poof");Poof.instance=null,Poof.prototype.initialize=function(){Poof.instance=this,this.entity.enabled=!1,this.entity.sprite.on("end",(t=>{this.entity.enabled=!1}))},Poof.prototype.play=function(t,o){this.entity.enabled=!0,this.entity.setLocalPosition(t.getLocalPosition()),this.entity.sprite.color=o?new pc.Color(.655,.71,.929):new pc.Color(1,1,1),this.entity.sprite.play("poof")};var RotateObject=pc.createScript("rotateObject");RotateObject.prototype.initialize=function(){this.speed=30;var t=pc.math.random(0,360);this.entity.setEulerAngles(0,0,t)},RotateObject.prototype.update=function(t){this.entity.rotate(0,0,-this.speed*t)};var IconLevelManager=pc.createScript("iconLevelManager");IconLevelManager.instance=null,IconLevelManager.attributes.add("levelIcons",{type:"entity",array:!0,title:"Objects"}),IconLevelManager.prototype.initialize=function(){IconLevelManager.instance=this,this.setIcon()},IconLevelManager.prototype.setIcon=function(){for(var e=0;e<this.levelIcons.length;e++)this.levelIcons[e].element.opacity=.2;var n=SaveSystem.getInstance().data.level;for(e=0;e<=n;e++)this.levelIcons[e].element.opacity=1};var OscillateRotate=pc.createScript("oscillateRotate");OscillateRotate.prototype.initialize=function(){this.minAngle=-10,this.maxAngle=10,this.currentAngle=pc.math.random(this.minAngle,this.maxAngle),this.direction=1;var t=this.entity.getLocalEulerAngles();this.entity.setLocalEulerAngles(t.x,t.y,this.currentAngle),this.speed=30},OscillateRotate.prototype.update=function(t){this.currentAngle+=this.speed*t*this.direction,this.currentAngle>=this.maxAngle?(this.currentAngle=this.maxAngle,this.direction=-1):this.currentAngle<=this.minAngle&&(this.currentAngle=this.minAngle,this.direction=1);var e=this.entity.getLocalEulerAngles();this.entity.setLocalEulerAngles(e.x,e.y,this.currentAngle)};var LightningSpawner=pc.createScript("lightningSpawner");LightningSpawner.instance=null,LightningSpawner.attributes.add("poolLightning",{type:"entity"}),LightningSpawner.attributes.add("xMin",{type:"number",default:-3}),LightningSpawner.attributes.add("xMax",{type:"number",default:3}),LightningSpawner.attributes.add("startY",{type:"number",default:2.5}),LightningSpawner.prototype.initialize=function(){LightningSpawner.instance=this,this.spawnInterval=10,this.maxObjects=10,this.currentObjects=[],this.spawnTimer=0,this.spawnCount=0,SaveSystem.getInstance().data.level>1?this.isSpawning=!0:this.isSpawning=!1},LightningSpawner.prototype.update=function(t){this.isSpawning&&(this.spawnTimer+=t,this.spawnTimer>=this.spawnInterval&&(this.spawnTimer=0,this.spawnObjectIfPossible()))},LightningSpawner.prototype.enableSpawning=function(){this.isSpawning=!0},LightningSpawner.prototype.disableSpawning=function(){this.spawnCount=0,this.isSpawning=!1,this.clearCurrentObjects()},LightningSpawner.prototype.clearCurrentObjects=function(){for(;this.currentObjects.length>0;){const t=this.currentObjects.pop();this.destroyObjectPool(t)}},LightningSpawner.prototype.spawnObjectIfPossible=function(){if(this.currentObjects.length>=this.maxObjects)return void console.log("Limit");const t=pc.math.random(this.xMin,this.xMax),n=this.startY;let i;i=this.poolLightning;const e=i.script.poolSystem.getObject();if(e){const i=new pc.Vec3(t,n,2);e.setPosition(i),e.enabled=!0,e.setEulerAngles(0,0,0),e.script&&e.script.lightning&&e.script.lightning.startLightning(3),this.currentObjects.push(e),this.spawnCount++}else console.warn("LightningSpawner: Failed to retrieve object from pool")},LightningSpawner.prototype.destroyObject=function(t){const n=this.currentObjects.indexOf(t);n>-1&&this.currentObjects.splice(n,1),this.poolLightning.script.poolSystem.returnObject(t)},LightningSpawner.prototype.destroyObjectPool=function(t){this.poolLightning.script.poolSystem.returnObject(t)};var Lightning=pc.createScript("lightning");Lightning.attributes.add("colliders",{type:"entity",array:!0}),Lightning.attributes.add("sprite",{type:"entity"}),Lightning.attributes.add("collidersParentObject",{type:"entity"}),Lightning.prototype.initialize=function(){this.sprite.sprite.opacity=0,this.isFlashing=!1,this.elapsedTime=0,this.flashDuration=0,this.nextFlashTime=0;for(var i=0;i<this.colliders.length;i++)this.colliders[i].collision.on("triggerenter",this.onTriggerEnter,this),this.colliders[i].collision.on("triggerleave",this.onTriggerExit,this);this.collidersParentObject.enabled=!1,this.isKill=!1},Lightning.prototype.update=function(i){if(this.isFlashing)if(this.elapsedTime+=i,this.nextFlashTime-=i,this.elapsedTime>=this.flashDuration)this.stopLightning();else if(this.nextFlashTime<=0){var t=Math.random()>.5;this.sprite.sprite.opacity=t?1:0,this.nextFlashTime=.15*Math.random()+.05}},Lightning.prototype.startLightning=function(i){this.elapsedTime=0,this.flashDuration=i,this.isFlashing=!0,this.nextFlashTime=0,this.collidersParentObject.enabled=!0,this.isKill=!1},Lightning.prototype.stopLightning=function(){this.isFlashing=!1,this.sprite.sprite.opacity=0,this.collidersParentObject.enabled=!1,this.isKill&&(this.lose(),this.isKill=!1),this.onLightningComplete()},Lightning.prototype.onLightningComplete=function(){LightningSpawner.instance.destroyObject(this.entity)},Lightning.prototype.onTriggerEnter=function(i){i.tags.has("umbrella")&&(this.isKill=!0)},Lightning.prototype.onTriggerExit=function(i){i.tags.has("umbrella")&&(this.isKill=!1)},Lightning.prototype.lose=function(){SoundManager.instance.play("Lose"),EmotionsController.instance.playSad(),HeartSystem.instance.disableNext()};var EmotionsController=pc.createScript("emotionsController");EmotionsController.instance=null,EmotionsController.attributes.add("idle",{type:"asset"}),EmotionsController.attributes.add("left",{type:"asset"}),EmotionsController.attributes.add("right",{type:"asset"}),EmotionsController.attributes.add("happyIdle",{type:"asset"}),EmotionsController.attributes.add("happyLeft",{type:"asset"}),EmotionsController.attributes.add("happyRight",{type:"asset"}),EmotionsController.attributes.add("sadIdle",{type:"asset"}),EmotionsController.attributes.add("sadLeft",{type:"asset"}),EmotionsController.attributes.add("sadRight",{type:"asset"}),EmotionsController.prototype.initialize=function(){if(EmotionsController.instance)return console.warn("EmotionsController already exists"),void this.entity.destroy();EmotionsController.instance=this,this.baseEmotion={idle:this.idle,left:this.left,right:this.right},this.currentTimeout=null,this.setEmotion(this.baseEmotion)},EmotionsController.prototype.setEmotion=function(t){this.entity.sprite.clip("Idle").sprite=t.idle.resource,this.entity.sprite.clip("MoveLeft").sprite=t.left.resource,this.entity.sprite.clip("MoveLeftNoLoop").sprite=t.left.resource,this.entity.sprite.clip("MoveRight").sprite=t.right.resource,this.entity.sprite.clip("MoveRightNoLoop").sprite=t.right.resource},EmotionsController.prototype.playEmotion=function(t,e=1){this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),this.setEmotion(t),this.currentTimeout=setTimeout((()=>{this.setEmotion(this.baseEmotion),this.currentTimeout=null}),1e3*e)},EmotionsController.prototype.playHappy=function(){this.playEmotion({idle:this.happyIdle,left:this.happyLeft,right:this.happyRight})},EmotionsController.prototype.playSad=function(){this.playEmotion({idle:this.sadIdle,left:this.sadLeft,right:this.sadRight})};var Test=pc.createScript("test");Test.prototype.initialize=function(){this.entity.element.mask=!1,this.entity.element.mask=!0},Test.prototype.update=function(t){};